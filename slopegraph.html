<!DOCTYPE html>
<html>
<head>
<title>D3 Slopegraph Workshop</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
<script src="http://codeorigin.jquery.com/jquery-2.0.3.min.js" charset="utf-8"></script>
<script src="jquery.fontselector.js" charset="utf-8"></script>
<script src="jquery-ui-1.10.3.custom.min.js" charset="utf-8"></script>
<script src="js/bootstrap.min.js"></script>
<link href="css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="fontselector.css">

<style>

#slopegraph {
	width: 900;
	height:6000;
	margin-left: 100px;
	padding: 30px;
	border:1px solid red;
}

</style>

<script>

var csvData = "" ;
var tmpCSV ;
var sgData ;

var minVal = Number.MAX_VALUE, 
    maxVal = Number.MIN_VALUE ;

var sgHeight = 600, 
    sgWidth = 175 ;

var sgScale ;
var sgSVG ;

var leftAxis,
    rightAxis,
    leftPoints,
		rightPoints,
		slopesLines ;
		
var marginLeft = 5,
    marginRight = 5, 
    marginTop = 20,
		marginBottom = 20 ;

var textMarginLeft = 200, 
    textMarginRight = 200 ;

var showAxes = false,
    showPoints = false ;
		
var textSpace = 5 ;

var textMargin = Number.MIN_VALUE ;
var slopeWidth = 200 ;
var fontFamily ;
var fontSize = 10 ;
var logScale ;

stringBBox = function(string, font, aclass) { 
    var f = font || '12px Times'; 
		var tmpSVG = d3.select("body").append("svg")
    var text = tmpSVG.append("svg:text") 
        .attr('class', aclass) 
				.attr('id', 'tmpsvg')
        .attr("x", 0) 
        .attr("y", 0) 
        .style("font", f) 
        .style("opacity", 0) 
        .text(string); 
    var txtBBox = text.node().getBBox(); 
		d3.select("#tmpsvg").remove();
		return(txtBBox);
} 

updateWidth = function() {
	slopeWidth = +$('#slWidth').val() ;
	$('#widthVal').text(slopeWidth) ;
}

updateHeight = function() {
	sgHeight = +$('#slHeight').val() ;
	$('#heightVal').text(sgHeight) ;
}

$(document).ready(function() {
	
	if (window.File && window.FileReader && window.FileList && window.Blob) {
	  // File APIs are supported.
	} else {
	  alert('File APIs are not fully supported in this browser.');
	}
	
	$('#fontSelect').fontSelector({
	        'hide_fallbacks' : true,
	        'initial' : 'Times New Roman,Times New Roman',
					'selected' : function(style) { fontFamily = style ; makeSlopegraph() },
	        'fonts' : [
	            'Arial,Arial',
	            'Courier New,Courier New',
	            'Georgia,Georgia',
	            'Gill Sans,Gill Sans',
	            'Helvetica Neue,Helvetica Neue',
	            'Lucida Console,Lucida Console',
	            'Lucida Sans Unicode, Lucida Sans Unicode',
	            'Palatino Linotype,Palatino Linotype',
	            'Tahoma,Tahoma',
	            'Times New Roman,Times New Roman',
	            'Trebuchet MS,Trebuchet MS',
	            'Verdana,Verdana'
	            ]
	});
					
});

makeSlopegraph = function() {	
	
	d3.select("#slopeSVG").remove() ;

	minVal = Number.MAX_VALUE;
	maxVal = Number.MIN_VALUE ;
	textMargin = Number.MIN_VALUE ;

	if ($('#hasHeader').is(':checked')) {

		sgData = d3.csv.parse(csvData, function(d) {

			// need min & max for scale		
			minVal = Math.min(minVal, +d.left, +d.right) ;
			maxVal = Math.max(maxVal, +d.left, +d.right) ;
			
			var lWidth = stringBBox(d.label + " " + d.left, fontSize + "px " + fontFamily).width ;
			var rWidth = stringBBox(d.label + " " + d.right, fontSize + "px " + fontFamily).width ;
		
		  textMargin = Math.max(+textMargin, +lWidth, +rWidth);
					
		  return {
				label:  d.label,
				 left: +d.left,
				right: +d.right
		  };
		
		}) ;

	} else {
		
		sgData = d3.csv.parseRows(csvData, function(d) {

			// need min & max for scale		
			minVal = Math.min(minVal, +d[1], +d[2]) ;
			maxVal = Math.max(maxVal, +d[1], +d[2]) ;
			
			var lWidth = stringBBox(d[0] + " " + d[1], fontSize + "px " + fontFamily).width ;
			var rWidth = stringBBox(d[0] + " " + d[2], fontSize + "px " + fontFamily).width ;
		
		  textMargin = Math.max(+textMargin, +lWidth, +rWidth);
					
		  return {
				label:  d[0],
				 left: +d[1],
				right: +d[2]
		  };
		
		}) ;
	
	};
				
  if ($('#logScale').is(':checked')) {
	  sgScale = d3.scale.log().domain([minVal, maxVal]).range([sgHeight, 0]); 
	} else {
		sgScale = d3.scale.linear().domain([minVal, maxVal]).range([sgHeight, 0]); 
	};
	
	sgSVG = d3.select("#slopegraph")
	          .append("svg")
						.attr("width", textMargin + textSpace + marginLeft + 
						               slopeWidth + 
													 marginRight + textSpace + textMargin + marginRight)
						.attr("height", sgHeight + marginTop + marginBottom)
						.attr("id", "slopeSVG");		
										
	slopeLines = sgSVG.selectAll(".slopeline")
										.data(sgData)
										.enter().append("line")
										.attr("x1", 0 + marginLeft + textMargin)
										.attr("y1", function(d) { return sgScale(d.left) + marginTop ;})
										.attr("x2", 0 + marginLeft + textMargin + slopeWidth)
										.attr("y2", function(d) { return sgScale(d.right) + marginTop ;})
										.style("stroke-width", "0.75")
										.style("stroke-opacity", "1")
										.style("stroke", function(d) {
											return("#CCCCCC");
											// var slp = d.right - d.left ;
											// if (slp < 0) {
											// 	return("#CCCCCC") ;
											// } else if (slp == 0) {
											// 	return("#BAE4B3") ;
											// } else if (slp > 0) {
											// 	return("#FCAE91") ;
											// }
										});
										
	rightLabels = sgSVG.selectAll(".labels")
										 .data(sgData)
										 .enter().append("text")
										 .attr("x", 0 + marginLeft + textMargin + slopeWidth + textSpace)
										 .attr("y", function(d) { return sgScale(d.right) + marginTop + (fontSize/2) })
										 .attr("font-family", fontFamily)
										 .attr("font-size", fontSize+"px")
										 .text(function(d) { return(d.right + " " + d.label) })
										 .attr("text-anchor", "start")
										 .attr("fill", "black");

	leftLabels = sgSVG.selectAll(".labels")
										 .data(sgData)
										 .enter().append("text")
										 .attr("x", 0 + marginLeft + textMargin - textSpace)
										 .attr("y", function(d) { return sgScale(d.left) + marginTop + (fontSize/2) })
										 .attr("font-family", fontFamily)
										 .attr("font-size", fontSize+"px")
										 .text(function(d) { return(d.label + " " + d.left) })
										 .attr("text-anchor", "end")
										 .attr("fill", "black");

};

</script>
</head>
<body>
<div class="page-header">
  <h1>D3 Slopegraph Workbench</h1>
</div>

	<div class="row">
	  <div class="col-md-2" style="padding-left:30px;">
			<input type="file" id="files" name="files[]"  />
			<output id="list"></output>

			<script>
			
			  function handleFileSelect(evt) {
			    var files = evt.target.files; 

			    for (var i = 0, f; f = files[i]; i++) {

			      if (!f.type.match('text.csv')) { // CSV files only
			        continue;
			      }

			      var reader = new FileReader();

			      reader.onload = (function(theFile) {
			        return function(e) {
								csvData = e.target.result ;
								tmpCSV = d3.csv.parseRows(csvData) ;
								$('#rowCount').text(tmpCSV.length + " rows read") ;
			        };
			      })(f);

			      reader.readAsText(f);
			    };
			  };

			  document.getElementById('files').addEventListener('change', handleFileSelect, false);
				
			</script>
			<div id="rowCount">
			</div>
		  <div class="checkbox">
		    <label>
		      <input type="checkbox" id="hasHeader"> Has header
		    </label>
			</div>
		  <div class="checkbox">
		    <label>
		      <input type="checkbox" id="logScale"> Log scale
		    </label>
			</div>	
			
			Select font: <div id="fontSelect" class="fontSelect">
			    <div class="arrow-down"></div>
			</div>			<br/>

			Select font size: <select id="fontSize" class="form-control" onChange="fontSize = $('#fontSize').val(); makeSlopegraph();">
								  <option>9</option>
								  <option selected>10</option>
								  <option>12</option>
								  <option>14</option>
								  <option>16</option>
								 </select>		
					 			<br/>	
			Slope width: <span id="widthVal">200</span><br/>100 <input type="range" id="slWidth" min="100" max="400" value="200" step="10" onChange="updateWidth()" style="width:75px"> 400	
			<br/><br/>
			Graph height: <span id="heightVal">600</span><br/>300 <input type="range" id="slHeight" min="300" max="3000" value="600" step="10" onChange="updateHeight()" style="width:75px"> 3000	
			<br/>
			<br/>
			<button type="button" class="btn btn-primary" onClick="makeSlopegraph()">Build/Update Slopegraph</button>
	  	
	  </div>
		
	  <div class="col-md-10" style="vertical-align:top;">
			<div id="slopegraph" class="slopegraph">
			</div>
		</div>
		
</div>
</body>
</html>
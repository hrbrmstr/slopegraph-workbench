<!DOCTYPE html>
<html>
<head>
<title>D3 Slopegraph Workshop</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
<script src="http://codeorigin.jquery.com/jquery-2.0.3.min.js" charset="utf-8"></script>
<script src="jquery.fontselector.js" charset="utf-8"></script>
<script src="jquery-ui-1.10.3.custom.min.js" charset="utf-8"></script>
<script src="js/jquery.dataTables.min.js" charset="utf-8"></script>
<script src="js/bootstrap.min.js"></script>
<link href="css/bootstrap.min.css" rel="stylesheet">
<link href="css/jquery.dataTables.css" rel="stylesheet">
<link rel="stylesheet" href="fontselector.css">

<style>

#slopegraph {
	width: 900;
	height:auto;
	margin-left: 100px;
	padding: 30px;
}

</style>

<script>

var csvData = "" ;
var tmpCSV ;
var sgData ;
var dt ;

var minVal = Number.MAX_VALUE, 
    maxVal = Number.MIN_VALUE ;

var sgHeight = 600, 
    sgWidth = 175 ;

var sgScale ;
var sgSVG ;

var marginLeft = 5,
    marginRight = 5, 
    marginTop = 20,
		marginBottom = 20 ;
		
var titleHeight = 20,
		titleSpace = 20 ;
		
var textSpace = 5 ;

var slopeWidth = 200 ;
var fontFamily ;
var fontSize = 12 ;
var logScale ;
var labelFormat = "" ;
var maxNumWidth = Number.MIN_VALUE,
    maxLabelWidth = Number.MIN_VALUE ;
		
var leftCollissions = [] ;
var rightCollissions = [] ;

var tData = [] ;
var tHead = [] ;


stringBBox = function(string, font) { 
    var f = font || '12px Times'; 
		var tmpSVG = d3.select("body").append("svg")
    var text = tmpSVG.append("svg:text") 
				.attr('id', 'tmpsvg')
        .attr("x", 0) 
        .attr("y", 0) 
        .style("font", f) 
        .style("opacity", 0) 
        .text(string); 
    var txtBBox = text.node().getBBox(); 
		d3.select("#tmpsvg").remove();
		return(txtBBox);
} 

updateWidth = function() {
	slopeWidth = +$('#slWidth').val() ;
	$('#widthVal').text(slopeWidth) ;
}

updateHeight = function() {
	sgHeight = +$('#slHeight').val() ;
	$('#heightVal').text(sgHeight) ;
}

updateLabelFormat = function() {
	labelFormat = $('#labelFmt').val() ;
}

$(document).ready(function() {
	
	if (window.File && window.FileReader && window.FileList && window.Blob) {
	  // File APIs are supported.
	} else {
	  alert('File APIs are not fully supported in this browser.');
	}
	
	$('#fontSelect').fontSelector({
	        'hide_fallbacks' : true,
	        'initial' : 'Times New Roman,Times New Roman',
					'selected' : function(style) { fontFamily = style ; makeSlopegraph() },
	        'fonts' : [
	            'Arial,Arial',
	            'Courier New,Courier New',
	            'Georgia,Georgia',
	            'Gill Sans,Gill Sans',
	            'Helvetica Neue,Helvetica Neue',
	            'Lucida Console,Lucida Console',
	            'Lucida Sans Unicode, Lucida Sans Unicode',
	            'Palatino Linotype,Palatino Linotype',
	            'Tahoma,Tahoma',
	            'Times New Roman,Times New Roman',
	            'Trebuchet MS,Trebuchet MS',
	            'Verdana,Verdana'
	            ]
	});
		
});

makeSlopegraph = function() {	
	
	d3.select("#slopeSVG").remove() ;
	
	var labelNumberFormatter = d3.format(labelFormat);

	minVal = Number.MAX_VALUE;
	maxVal = Number.MIN_VALUE ;
	
	maxNumWidth = Number.MIN_VALUE;
  maxLabelWidth = Number.MIN_VALUE ;
	
	if ($('#hasHeader').is(':checked')) {

		sgData = d3.csv.parse(csvData, function(d) {

			minVal = Math.min(minVal, +d.left, +d.right) ;
			maxVal = Math.max(maxVal, +d.left, +d.right) ;
					
			maxLabelWidth = Math.max(+maxLabelWidth, 
											         +stringBBox(d.label, fontSize + "px " + fontFamily).width);		
															 	
			maxNumWidth = Math.max(+maxNumWidth, 
											       +stringBBox(labelNumberFormatter(d.left), fontSize + "px " + fontFamily).width,
											       +stringBBox(labelNumberFormatter(d.right), fontSize + "px " + fontFamily).width);
					
		  return {
				label:  d.label,
				 left: +d.left,
				right: +d.right
		  };
		
		}) ;

	} else {
		
		sgData = d3.csv.parseRows(csvData, function(d) {

			minVal = Math.min(minVal, +d[1], +d[2]) ;
			maxVal = Math.max(maxVal, +d[1], +d[2]) ;

			maxLabelWidth = Math.max(+maxLabelWidth, 
											         +stringBBox(d[0], fontSize + "px " + fontFamily).width);			
			maxNumWidth = Math.max(+maxNumWidth, 
											       +stringBBox(labelNumberFormatter(d[1]), fontSize + "px " + fontFamily).width,
											       +stringBBox(labelNumberFormatter(d[2]), fontSize + "px " + fontFamily).width);
					
		  return {
				label:  d[0],
				 left: +d[1],
				right: +d[2]
		  };
		
		}) ;
	
	};
				
  if ($('#logScale').is(':checked')) {
	  sgScale = d3.scale.log().domain([minVal, maxVal]).range([sgHeight, 0]); 
	} else {
		sgScale = d3.scale.linear().domain([minVal, maxVal]).range([sgHeight, 0]); 
	};
	
	titleHeight = stringBBox("Test", "bold " + fontSize + "px" + fontFamily).height ;
	
	sgSVG = d3.select("#slopegraph")
	          .append("svg")
						.attr("width", marginLeft + maxLabelWidth + textSpace + maxNumWidth + textSpace + 
													 slopeWidth +
													 textSpace + maxNumWidth + textSpace + maxLabelWidth + marginRight)
						.attr("height", sgHeight + marginTop + titleHeight + titleSpace + marginBottom)
						.attr("id", "slopeSVG");		
										

	leftTitle = sgSVG.append("text")
										.attr("x", marginLeft + maxLabelWidth + textSpace + maxNumWidth)
										.attr("y", marginTop + titleHeight )
										.attr("font-family", fontFamily)
										.attr("font-weight", "bold")
										.attr("font-size", fontSize+"px")
										.text($('#leftTitle').val())
										.attr("text-anchor", "end")
										.attr("fill", "black");

	rightTitle = sgSVG.append("text")
										 .attr("x", marginLeft + maxLabelWidth + textSpace + maxNumWidth + textSpace + slopeWidth + textSpace)
										 .attr("y", marginTop + titleHeight )
										 .attr("font-family", fontFamily)
 										 .attr("font-weight", "bold")
										 .attr("font-size", fontSize+"px")
										 .text($('#rightTitle').val())
										 .attr("text-anchor", "start")
										 .attr("fill", "black");

	slopeLines = sgSVG.selectAll(".slopeline")
										.data(sgData)
										.enter().append("line")
										.attr("x1", marginLeft + maxLabelWidth + textSpace + maxNumWidth + textSpace)
										.attr("y1", function(d) { return sgScale(d.left) + marginTop + titleHeight + titleSpace ;})
										.attr("x2", marginLeft + maxLabelWidth + textSpace + maxNumWidth + textSpace + slopeWidth)
										.attr("y2", function(d) { return sgScale(d.right) + marginTop + titleHeight + titleSpace ;})
										.style("stroke-width", "0.75")
										.style("stroke-opacity", "1")
										.style("stroke", function(d) {
											return("#CCCCCC");
											// var slp = d.right - d.left ;
											// if (slp < 0) {
											// 	return("#CCCCCC") ;
											// } else if (slp == 0) {
											// 	return("#BAE4B3") ;
											// } else if (slp > 0) {
											// 	return("#FCAE91") ;
											// }
										});

	rightNumbers = sgSVG.selectAll(".numbers")
										  .data(sgData)
										  .enter().append("text")
										  .attr("x", marginLeft + maxLabelWidth + textSpace + maxNumWidth + textSpace + slopeWidth + textSpace)
										  .attr("y", function(d) { return sgScale(d.right) + marginTop + titleHeight + titleSpace + Math.ceil(fontSize/2) })
										  .attr("font-family", fontFamily)
										  .attr("font-size", fontSize+"px")
										  .text(function(d) { return(labelNumberFormatter(d.right)); })
										  .attr("text-anchor", "start")
										  .attr("fill", "black");
										
	rightLabels = sgSVG.selectAll(".labels")
										 .data(sgData)
										 .enter().append("text")
										 .attr("x", marginLeft + maxLabelWidth + textSpace + maxNumWidth + textSpace + slopeWidth + textSpace + maxNumWidth + textSpace)
										 .attr("y", function(d) { return sgScale(d.right) + marginTop + titleHeight + titleSpace + Math.ceil(fontSize/2) })
										 .attr("font-family", fontFamily)
										 .attr("font-size", fontSize+"px")
										 .text(function(d) { return(d.label); })
										 .attr("text-anchor", "start")
										 .attr("fill", "black");

 	leftLabels = sgSVG.selectAll(".labels")
 										 .data(sgData)
 										 .enter().append("text")
 										 .attr("x", marginLeft + maxLabelWidth)
 										 .attr("y", function(d) { return sgScale(d.left) + marginTop + titleHeight + titleSpace + (fontSize/2) })
 										 .attr("font-family", fontFamily)
 										 .attr("font-size", fontSize+"px")
 										 .text(function(d) { return(d.label); })
 										 .attr("text-anchor", "end")
 										 .attr("fill", "black");

 	leftNumbers = sgSVG.selectAll(".numbers")
 										 .data(sgData)
 										 .enter().append("text")
 										 .attr("x", marginLeft + maxLabelWidth + textSpace + maxNumWidth)
 										 .attr("y", function(d) { return sgScale(d.left) + marginTop + titleHeight + titleSpace + (fontSize/2) })
 										 .attr("font-family", fontFamily)
 										 .attr("font-size", fontSize+"px")
 										 .text(function(d) { return(labelNumberFormatter(d.left)); })
 										 .attr("text-anchor", "end")
 										 .attr("fill", "black");


};

</script>
</head>
<body>
<div class="page-header" style="padding-left:20px;">
  <h1>D3 Slopegraph Workbench</h1>
</div>

	<div class="row">
	  <div class="col-md-3" style="padding-left:30px;">
			Select CSV file: 
			<input type="file" id="files" name="files[]"  />
			<output id="list"></output>

			<script>
			
			  function handleFileSelect(evt) {
			    var files = evt.target.files; 

			    for (var i = 0, f; f = files[i]; i++) {

			      if (!f.type.match('text.csv')) { // CSV files only
			        continue;
			      }

			      var reader = new FileReader();

			      reader.onload = (function(theFile) {
			        return function(e) {
								csvData = e.target.result ;
								tData = [] ;
								tmpCSV = d3.csv.parseRows(csvData, function(d) {
									tData.push([ d[0], d[1], d[2] ]);							
								  return {
										label:  d.label,
										 left: +d.left,
										right: +d.right
								  };		
								}) ;
								$('#rowCount').text(tmpCSV.length + " rows read") ;								
				
								if (!(typeof(dt) === 'undefined')) {
									dt.fnClearTable() ;
									$('#sgTableDiv').empty();
								}
								
								$('#sgTableDiv').html( '<table cellpadding="0" cellspacing="0" border="0" class="display" id="sgTable"></table>' );
	
								dt = $('#sgTable').dataTable( {
									 "bSort": false,
									 "bFilter": false,
									 "bInfo": false,
									 "iDisplayLength" : -1,
									 "aaData" : tData,
									 "aoColumns" : [ { "sTitle" : "label" }, {"sTitle":"left"},{"sTitle":"right"} ] 
								 } );
								
			        };
			      })(f);

			      reader.readAsText(f);
			    };
			  };

			  document.getElementById('files').addEventListener('change', handleFileSelect, false);
				
			</script>
			<span id="rowCount" style="color:red;"></span>
			
			<div class="panel-group" id="accordion">
			  <div class="panel panel-default">
			    <div class="panel-heading">
			      <h4 class="panel-title">
			        <a data-toggle="collapse" data-parent="#accordion" href="#collapseOne">
			          Data Table
			        </a>
			      </h4>
			    </div>
			    <div id="collapseOne" class="panel-collapse collapse">
			      <div class="panel-body">
							<div id="sgTableDiv"></div>
			      </div>
			    </div>
			  </div>
			</div>			
			
		  <div class="checkbox">
		    <label>
		      <input type="checkbox" id="hasHeader"> Has header
		    </label>
			</div>
		  <div class="checkbox">
		    <label>
		      <input type="checkbox" id="logScale"> Log scale
		    </label>
			</div>	
			
			Label format string: <input type="text" width="10" id="labelFmt" onChange="updateLabelFormat();"/><br/><br/>
			<div class="panel-group" id="fonts">
			  <div class="panel panel-default">
			    <div class="panel-heading">
			      <h4 class="panel-title">
			        <a data-toggle="collapse" data-parent="#fonts" href="#fontsC">
			          Fonts
			        </a>
			      </h4>
			    </div>
			    <div id="fontsC" class="panel-collapse collapse">
						<div style="padding-left:20px; padding-bottom:10px; padding-top:10px">
						Select label font: <div id="fontSelect" class="fontSelect">
						    <div class="arrow-down"></div>
						</div>			<br/>
			Select label font size: <select id="fontSize" class="form-control" style="width:50px" onChange="fontSize = $('#fontSize').val(); makeSlopegraph();">
								  <option>9</option>
								  <option>10</option>
								  <option selected>12</option>
								  <option>14</option>
								  <option>16</option>
								 </select>
							 </div>
							</div>
				    </div>
				  </div>
				<br/>
				<div class="panel-group" id="heightwidth">
				  <div class="panel panel-default">
				    <div class="panel-heading">
				      <h4 class="panel-title">
				        <a data-toggle="collapse" data-parent="#heightwidth" href="#collapseOneB">
				          Height/Width
				        </a>
				      </h4>
				    </div>
				    <div id="collapseOneB" class="panel-collapse collapse">
				      <div class="panel-body">
								Slope width: <span id="widthVal">200</span><br/>100 <input type="range" id="slWidth" min="100" max="400" value="200" step="10" onChange="updateWidth()" style="width:105px"> 400	
								<br/><br/>
								Graph height: <span id="heightVal">600</span><br/>300 <input type="range" id="slHeight" min="300" max="3000" value="600" step="100" onChange="updateHeight()" style="width:95px"> 3000	
				      </div>
				    </div>
				  </div>
				</div>			
				<br/>			
			<div class="panel-group" id="annotations">
			  <div class="panel panel-default">
			    <div class="panel-heading">
			      <h4 class="panel-title">
			        <a data-toggle="collapse" data-parent="#annotations" href="#collapseOneA">
			          Annotations
			        </a>
			      </h4>
			    </div>
			    <div id="collapseOneA" class="panel-collapse collapse">
			      <div class="panel-body">
							Left Axis Title:<br/><input id="leftTitle" type="text" size="30"/><br/>
							Right Axis Title:<br/><input id="rightTitle" type="text" size="30"/><br/>
							Chart Description:<br/><textarea id="chartDescription" cols="35" rows="5"></textarea>
			      </div>
			    </div>
			  </div>
			</div>			
			<br/>
			
			<center><button type="button" class="btn btn-primary" onClick="makeSlopegraph()">Build/Update Slopegraph</button></center>
	  	
	  </div>
		
	  <div class="col-md-9" style="vertical-align:top;">
			<div id="slopegraph" class="slopegraph" style="overflow-y: scroll;">
			</div>
		</div>
		
</div>
</body>
</html>